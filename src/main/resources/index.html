<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lookup Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
<div class="container py-4">
    <label for="lookupInput" class="form-label">Lookup</label>
    <div class="position-relative" style="max-width:420px">
        <input id="lookupInput" class="form-control" type="text" autocomplete="off" placeholder="Start typing..." />
        <ul id="lookupMenu" class="list-group position-absolute w-100 shadow-sm" style="z-index:1000; display:none; max-height:260px; overflow:auto;"></ul>
    </div>
    <div id="toast" class="text-success small mt-2" style="display:none;"></div>
</div>
<script>
    (() => {
      const input = document.getElementById('lookupInput');
      const menu  = document.getElementById('lookupMenu');
      const toast = document.getElementById('toast');

      let lastQuery = '';
      let hideTimer;

      const debounce = (fn, ms=150) => {
        let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }
      };

      const showMenu = () => { menu.style.display = 'block'; };
      const hideMenu = () => { menu.style.display = 'none'; };

      const setToast = (msg) => {
        toast.textContent = msg; toast.style.display = 'block';
        clearTimeout(hideTimer); hideTimer = setTimeout(() => toast.style.display = 'none', 2500);
      };

      const renderItems = (q, items) => {
        menu.innerHTML = '';
        if (items.length === 0) {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `<span>No matches</span>
            <button class="btn btn-sm btn-primary">Add “${q}”</button>`;
          li.querySelector('button').onclick = () => addValue(q);
          menu.appendChild(li);
        } else {
          items.forEach(v => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';
            li.textContent = v;
            li.onclick = () => { input.value = v; hideMenu(); };
            menu.appendChild(li);
          });
          // If the typed text isn't identical to any item, offer an add row
          if (q && !items.some(x => x.toLowerCase() === q.toLowerCase())) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<em class="text-muted">Not found</em>
              <button class="btn btn-sm btn-outline-primary">Add “${q}”</button>`;
            li.querySelector('button').onclick = () => addValue(q);
            menu.appendChild(li);
          }
        }
        showMenu();
      };

      const search = async (q) => {
        lastQuery = q;
        try {
          const r = await fetch(`/api/lookup?q=${encodeURIComponent(q)}&limit=8`);
          if (!r.ok) return;
          const data = await r.json();
          if (q === lastQuery) renderItems(q, data);
        } catch (e) { /* ignore network blips */ }
      };

      const addValue = async (v) => {
        // Optimistic UX
        setToast(`Saved locally: “${v}” (will sync to DB when available).`);
        try {
          await fetch('/api/lookup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ value: v })
          });
        } catch (e) { /* ignore errors by design */ }
        input.value = v; hideMenu();
      };

      input.addEventListener('focus', () => search(input.value));
      input.addEventListener('input', debounce(() => search(input.value), 150));
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#lookupMenu') && e.target !== input) hideMenu();
      });
    })();
</script>
</body>
</html>