<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lookup Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
<div class="container py-4">
    <label for="lookupInput" class="form-label">Lookup</label>
    <div class="position-relative" style="max-width:420px">
        <input id="lookupInput" data-key="default" class="form-control" type="text" autocomplete="off" placeholder="Start typing..." />
        <ul id="lookupMenu" class="list-group position-absolute w-100 shadow-sm" style="z-index:1000; display:none; max-height:260px; overflow:auto;"></ul>
    </div>
    <div id="toast" class="text-success small mt-2" style="display:none;"></div>
    <label for="lookupInput" class="form-label">Lookup</label>
    <div class="position-relative" style="max-width:420px">
        <input id="lookupInput1" data-key="default" class="form-control" type="text" autocomplete="off" placeholder="Start typing..." />
        <ul id="lookupMenu1" class="list-group position-absolute w-100 shadow-sm" style="z-index:1000; display:none; max-height:260px; overflow:auto;"></ul>
    </div>
    <div id="toast1" class="text-success small mt-2" style="display:none;"></div>
</div>
<script>
    function setupLookup(inputId, menuId, toastId) {
      const input = document.getElementById(inputId);
      const menu  = document.getElementById(menuId);
      const toast = document.getElementById(toastId);
      const LOOKUP_KEY = input.dataset.key;
      const base = `/portal/api/lookup/${LOOKUP_KEY}`;

      let lastQuery = '';
      let hideTimer;

      const debounce = (fn, ms=150) => { let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };

      const showMenu = () => { menu.style.display = 'block'; };
      const hideMenu = () => { menu.style.display = 'none'; };
      const setToast = (msg) => { toast.textContent = msg; toast.style.display = 'block';
        clearTimeout(hideTimer); hideTimer = setTimeout(() => toast.style.display = 'none', 2500); };

      const renderItems = (q, items) => {
        menu.innerHTML = '';
        if (items.length === 0) {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `<span>No matches</span>
            <button class="btn btn-sm btn-primary">Add “${q}”</button>`;
          li.querySelector('button').onclick = () => addValue(q);
          menu.appendChild(li);
        } else {
          items.forEach(v => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<span class="me-2 flex-grow-1">${v}</span>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary select-btn">Select</button>
                <button class="btn btn-outline-danger delete-btn" title="Delete">✕</button>
              </div>`;
            li.querySelector('.select-btn').onclick = () => { input.value = v; hideMenu(); };
            li.querySelector('.delete-btn').onclick = () => deleteValue(v);
            menu.appendChild(li);
          });
          if (q && !items.some(x => x.toLowerCase() === q.toLowerCase())) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<em class="text-muted">Not found</em>
              <button class="btn btn-sm btn-outline-primary">Add “${q}”</button>`;
            li.querySelector('button').onclick = () => addValue(q);
            menu.appendChild(li);
          }
        }
        showMenu();
      };

      const search = async (q) => {
        lastQuery = q;
        try {
          const r = await fetch(`${base}?q=${encodeURIComponent(q)}&limit=8`);
          if (!r.ok) return;
          const data = await r.json();
          if (q === lastQuery) renderItems(q, data);
        } catch {}
      };

      const addValue = async (v) => {
        setToast(`Saved locally: “${v}” (will sync to DB when available).`);
        try {
          await fetch(base, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ value: v })
          });
        } catch {}
        input.value = v; hideMenu();
      };

      const deleteValue = async (v) => {
        setToast(`Removed locally: “${v}” (DB will update when available).`);
        try {
          const url = `${base}?value=${encodeURIComponent(v)}`;
          await fetch(url, { method: 'DELETE' });
          search(input.value);
        } catch {}
      };

      input.addEventListener('focus', () => search(input.value));
      input.addEventListener('input', debounce(() => search(input.value), 150));
      document.addEventListener('click', (e) => {
        if (!e.target.closest(`#${menuId}`) && e.target !== input) hideMenu();
      });
    }

    // Usage for each lookup field:
    setupLookup('lookupInput', 'lookupMenu', 'toast');
    setupLookup('lookupInput1', 'lookupMenu1', 'toast1');
</script>
</body>
</html>