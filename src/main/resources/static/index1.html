<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Multi Lookup Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        .lookup-wrap { position: relative; max-width: 480px; }
        .lookup-menu {
          position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;
          display: none; max-height: 260px; overflow: auto;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <h1 class="h4 mb-4">Two Lookup Fields (single JS)</h1>

    <!-- Lookup #1 -->
    <div class="mb-4">
        <label class="form-label">Departments</label>
        <div class="lookup-wrap">
            <input class="form-control" type="text" placeholder="Type department…"
                   data-lookup data-key="departments" data-limit="8"/>
            <ul class="list-group shadow-sm lookup-menu"></ul>
        </div>
    </div>

    <!-- Lookup #2 -->
    <div class="mb-4">
        <label class="form-label">Skills</label>
        <div class="lookup-wrap">
            <input class="form-control" type="text" placeholder="Type skill…"
                   data-lookup data-key="skills" data-limit="8"/>
            <ul class="list-group shadow-sm lookup-menu"></ul>
        </div>
    </div>

    <!-- Optional shared toast -->
    <div id="lookup-toast" class="small text-success" style="display:none;"></div>
</div>

<script>
    (() => {
      // ===== Utilities =====
      const debounce = (fn, ms=150) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } };
      const show = el => el.style.display = 'block';
      const hide = el => el.style.display = 'none';
      const toast = document.getElementById('lookup-toast');
      const setToast = (msg) => { if (!toast) return; toast.textContent = msg; show(toast); setTimeout(()=> hide(toast), 2500); };

      // ===== Core initializer (single function) =====
      function initLookup(inputEl) {
        if (!inputEl || inputEl._lookupBound) return; // idempotent
        inputEl._lookupBound = true;

        const wrap = inputEl.closest('.lookup-wrap');
        const menu = wrap.querySelector('.lookup-menu');
        const key = (inputEl.dataset.key || 'default').trim();
        const limit = parseInt(inputEl.dataset.limit || '8', 10);
        const base = `/portal/api/lookup/${encodeURIComponent(key)}`;

        let lastQuery = '';

        // Render results list for this widget
        const render = (q, items) => {
          menu.innerHTML = '';
          if (!items || items.length === 0) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<span>No matches</span>
                            <button class="btn btn-sm btn-primary">Add “${escapeHtml(q)}”</button>`;
            li.querySelector('button').onclick = () => addValue(q);
            menu.appendChild(li);
          } else {
            items.forEach(v => {
              const li = document.createElement('li');
              li.className = 'list-group-item d-flex justify-content-between align-items-center';
              li.innerHTML = `<span class="me-2 flex-grow-1">${escapeHtml(v)}</span>
                              <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary select-btn">Select</button>
                                <button class="btn btn-outline-danger delete-btn" title="Delete">✕</button>
                              </div>`;
              li.querySelector('.select-btn').onclick = () => { inputEl.value = v; hide(menu); };
              li.querySelector('.delete-btn').onclick = () => deleteValue(v);
              menu.appendChild(li);
            });
            // Offer add row if typed text is not an exact match
            if (q && !items.some(x => x.toLowerCase() === q.toLowerCase())) {
              const li = document.createElement('li');
              li.className = 'list-group-item d-flex justify-content-between align-items-center';
              li.innerHTML = `<em class="text-muted">Not found</em>
                              <button class="btn btn-sm btn-outline-primary">Add “${escapeHtml(q)}”</button>`;
              li.querySelector('button').onclick = () => addValue(q);
              menu.appendChild(li);
            }
          }
          show(menu);
        };

        // Query suggestions for this widget
        const search = async (q) => {
          lastQuery = q;
          try {
            const r = await fetch(`${base}/suggest?q=${encodeURIComponent(q)}&limit=${limit}`);
            if (!r.ok) return;
            const data = await r.json();
            if (q === lastQuery) render(q, data);
          } catch { /* network hiccup ignored */ }
        };

        // Add value for this widget
        const addValue = async (v) => {
          if (!v || !v.trim()) return;
          setToast(`Saved locally to “${key}”: “${v}” (DB sync async).`);
          try {
            await fetch(`${base}/add`, {
              method: 'POST', headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ value: v })
            });
          } catch {}
          inputEl.value = v; hide(menu);
        };

        // Delete value for this widget
        const deleteValue = async (v) => {
          if (!v || !v.trim()) return;
          setToast(`Removed locally from “${key}”: “${v}” (DB sync async).`);
          try {
            await fetch(`${base}/delete?value=${encodeURIComponent(v)}`, { method: 'DELETE' });
          } catch {}
          // Re-query to reflect deletion
          search(inputEl.value);
        };

        // Wire events
        inputEl.addEventListener('focus', () => search(inputEl.value || ''));
        inputEl.addEventListener('input', debounce(() => search(inputEl.value || ''), 150));
        document.addEventListener('click', (e) => {
          if (!wrap.contains(e.target)) hide(menu);
        });
      }

      // Escape helper (basic)
      function escapeHtml(s) {
        return (s ?? '').replace(/[&<>"']/g, c =>
          ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
        );
      }

      // Auto-init all lookup inputs (two or more)
      window.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[data-lookup]').forEach(initLookup);
      });
    })();
</script>
</body>
</html>
